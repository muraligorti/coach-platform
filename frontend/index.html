<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CoachFlow</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-0:#0c0f14;--bg-1:#12161e;--bg-2:#191f2b;--bg-3:#212938;--border:#2a3347;--border-light:#364054;--accent:#e8a838;--green:#34d399;--red:#f87171;--yellow:#fbbf24;--blue:#60a5fa;--text-0:#f4f0eb;--text-1:#c8c2b8;--text-2:#8a8477;--text-3:#5e5a52;--font:'Outfit',sans-serif;--r-lg:14px;--r-md:10px;--r-sm:7px}
*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font);background:var(--bg-0);color:var(--text-0);display:flex;min-height:100vh}
.rail{width:68px;background:var(--bg-1);border-right:1px solid var(--border);height:100vh;position:fixed;display:flex;flex-direction:column;align-items:center;padding:14px 0;gap:2px;z-index:10;overflow-y:auto}
.rail button{width:48px;padding:6px 0;border:none;background:transparent;color:var(--text-3);border-radius:10px;cursor:pointer;font-size:16px;transition:.2s;display:flex;flex-direction:column;align-items:center;gap:2px}
.rail button span{font-size:8px;font-weight:600}
.rail button:hover{background:var(--bg-3)}.rail button.active{background:rgba(232,168,56,.12);color:var(--accent)}
.rail .logo{width:36px;height:36px;background:var(--accent);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#000;margin-bottom:8px;flex-shrink:0}
.stage{margin-left:68px;flex:1;padding:16px 20px;max-width:1400px}
.topbar{height:52px;background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:space-between;padding:0 16px;margin-bottom:14px}
.topbar h2{font-size:15px;font-weight:700}.topbar .sub{font-size:11px;color:var(--text-2);margin-left:8px}
.card{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;margin-bottom:10px}
.card-title{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.btn{padding:6px 12px;border-radius:var(--r-sm);border:1px solid var(--border-light);background:var(--bg-3);color:var(--text-0);font-size:11px;cursor:pointer;font-family:var(--font);transition:.15s}
.btn:hover{border-color:var(--text-2)}.btn-accent{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.btn-accent:hover{background:#d49a30}.btn-sm{padding:3px 8px;font-size:10px}
.btn-red{border-color:var(--red);color:var(--red)}.btn-green{border-color:var(--green);color:var(--green)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.stat{text-align:center;padding:12px;cursor:pointer;transition:.15s;border-radius:var(--r-md)}.stat:hover{background:var(--bg-2)}.stat h3{font-size:26px;font-weight:800;margin-bottom:2px}.stat p{font-size:11px;color:var(--text-2)}
input,select,textarea{background:var(--bg-2);border:1px solid var(--border);color:var(--text-0);border-radius:var(--r-sm);padding:7px 10px;font-size:12px;font-family:var(--font);width:100%}
input:focus,select:focus{outline:none;border-color:var(--accent)}
label{font-size:11px;color:var(--text-2);margin-bottom:3px;display:block}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
.form-group{margin-bottom:8px}
table{width:100%;font-size:12px;border-collapse:collapse}
th{text-align:left;color:var(--text-3);font-size:10px;text-transform:uppercase;padding:8px 6px;border-bottom:1px solid var(--border)}
td{padding:7px 6px;border-bottom:1px solid var(--bg-3)}
.chip{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:20px;font-size:11px;cursor:pointer;color:var(--text-1);margin:2px;transition:.15s;user-select:none}
.chip.active{border-color:var(--accent);color:var(--accent);background:rgba(232,168,56,.12)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-green{background:rgba(52,211,153,.15);color:var(--green)}.badge-red{background:rgba(248,113,113,.15);color:var(--red)}
.badge-yellow{background:rgba(251,191,36,.15);color:var(--yellow)}.badge-blue{background:rgba(96,165,250,.15);color:var(--blue)}
.badge-accent{background:rgba(232,168,56,.15);color:var(--accent)}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100}
.modal{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--r-lg);padding:20px;width:90%;max-width:460px;max-height:80vh;overflow-y:auto}
.modal h3{font-size:15px;margin-bottom:14px}
.toast{position:fixed;bottom:20px;right:20px;padding:10px 18px;border-radius:var(--r-md);font-size:12px;z-index:200;animation:slideUp .3s}
.toast-ok{background:var(--green);color:#000}.toast-err{background:var(--red);color:#fff}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.empty{text-align:center;padding:30px;color:var(--text-3);font-size:13px}
.loading{text-align:center;padding:20px;color:var(--text-2);font-size:12px}
.clickable{cursor:pointer;transition:.15s}.clickable:hover{background:var(--bg-2);border-radius:6px}
/* Scheduler */
.sched-wrap{display:grid;grid-template-columns:140px 1fr;gap:10px}
.sched-sidebar .cli{background:var(--bg-3);border:1px solid var(--border-light);border-radius:6px;padding:6px 10px;margin-bottom:4px;font-size:11px;display:flex;align-items:center;gap:6px;cursor:grab}
.cli.online{border-left:3px solid var(--blue)}.cli.offline{border-left:3px solid var(--green)}
.cli-eye{margin-left:auto;cursor:pointer;opacity:.4;font-size:12px;transition:.15s;flex-shrink:0}.cli-eye:hover{opacity:1;color:var(--accent)}
.sched-grid{display:grid;gap:4px;font-size:10px}
.sched-hdr{text-align:center;font-weight:700;color:var(--text-1);font-size:11px;padding:4px}
.sched-hdr.is-today{color:var(--accent);text-decoration:underline}
.sched-hdr.is-holiday{color:var(--red);text-decoration:line-through}
.sched-time{color:var(--text-3);padding:6px 4px 0;text-align:right;font-size:10px}
.sched-time.now-hr{color:var(--accent);font-weight:700}
.sched-cell{background:var(--bg-2);border:1px dashed var(--border);border-radius:6px;min-height:42px;padding:3px;position:relative;transition:.15s}
.sched-cell.drag-over{border-color:var(--accent);background:rgba(232,168,56,.08)}
.sched-cell.full{background:rgba(248,113,113,.12);border-color:var(--red);border-style:solid}
.sched-cell.at-max{background:rgba(251,191,36,.06);border-color:var(--yellow)}
.sched-cell.now-slot{box-shadow:inset 0 0 0 1px var(--accent)}
.slot-cap{position:absolute;top:1px;right:3px;font-size:8px;color:var(--text-3);font-weight:700}
.slot-cap.full{color:var(--red)}.slot-cap.at-max{color:var(--yellow)}
.sched-evt{padding:4px 6px;border-radius:4px;font-size:10px;margin-bottom:2px;display:flex;justify-content:space-between;align-items:center}
.sched-evt.online{background:rgba(96,165,250,.12);border-left:3px solid var(--blue);color:var(--blue)}
.sched-evt.offline{background:rgba(52,211,153,.12);border-left:3px solid var(--green);color:var(--green)}
.evt-main{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;flex:1;min-width:0}
.evt-actions{display:flex;gap:1px;opacity:0;transition:.15s;flex-shrink:0}.sched-evt:hover .evt-actions{opacity:1}
.evt-del{font-size:9px;color:var(--red);cursor:pointer;padding:2px 3px;border-radius:4px}.evt-del:hover{background:rgba(248,113,113,.2)}
.evt-att{font-size:10px;cursor:pointer;padding:1px 4px;border-radius:4px;font-weight:800}
.att-ok{color:var(--green)}.att-ok:hover{background:rgba(52,211,153,.2)}
.att-no{color:var(--red)}.att-no:hover{background:rgba(248,113,113,.2)}
.cancel-day-btn{font-size:9px;display:block;color:var(--text-3);cursor:pointer;text-align:center;margin-top:2px}.cancel-day-btn:hover{color:var(--red)}
.date-nav{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.date-nav button{background:var(--bg-3);border:1px solid var(--border);color:var(--text-0);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;font-family:var(--font)}
.date-nav button:hover{border-color:var(--accent)}.date-nav .today-btn{padding:4px 10px;font-size:10px;width:auto}
/* Panel */
.cli-panel-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:90;display:flex;justify-content:flex-end}
.cli-panel{width:420px;max-width:90vw;height:100vh;background:var(--bg-1);border-left:1px solid var(--border);padding:20px;overflow-y:auto;animation:slideIn .2s ease-out}
@keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
.cli-panel h3{font-size:15px;font-weight:700;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center}
.cli-panel .tab-row{display:flex;gap:4px;margin-bottom:12px;background:var(--bg-0);border-radius:8px;padding:3px}
.cli-panel .tab-btn{flex:1;padding:6px 0;text-align:center;font-size:11px;font-weight:600;border-radius:6px;cursor:pointer;color:var(--text-2);border:none;background:transparent;font-family:var(--font)}
.cli-panel .tab-btn.active{background:var(--bg-3);color:var(--text-0);border:1px solid var(--border)}
.sess-item{display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg-2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:11px}
@media(max-width:768px){.rail{width:52px}.rail button span{display:none}.stage{margin-left:52px;padding:10px}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}.sched-wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<nav class="rail" id="rail"></nav>
<main class="stage" id="app"></main>
<script>
const API_HOSTS=['https://api.coachme.life/api/v1','https://coach-api-1770519048.azurewebsites.net/api/v1'];
const API=API_HOSTS[0]==='https://api.coachme.life/api/v1'&&location.hostname.includes('coachme.life')?API_HOSTS[0]:API_HOSTS[1];
let USER=null,SCREEN='dashboard';
try{USER=JSON.parse(localStorage.getItem('cf_user'))}catch{}
function cid(){return USER?.id||''}
function hdr(){return{'Content-Type':'application/json','X-Coach-Id':cid()}}
async function api(ep,o={}){try{const r=await fetch(API+ep,{headers:hdr(),...o});if(!r.ok&&r.status===405){console.error('405 Method Not Allowed:',ep,o.method||'GET');return{success:false,detail:'Method not allowed (405). Backend may need redeployment. Endpoint: '+ep}}const j=await r.json();return j}catch(e){console.error(ep,e);return{success:false,detail:e.message}}}
function toast(m,ok=true){const t=document.createElement('div');t.className='toast '+(ok?'toast-ok':'toast-err');t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
function $(id){return document.getElementById(id)}
function h(s){return(s||'').replace(/</g,'&lt;')}
function closeModal(){document.querySelector('.modal-bg')?.remove()}
function parseServerTime(s){const m=s.match(/(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);if(!m)return{h:0,mi:0,dateStr:s};return{y:+m[1],mo:+m[2],d:+m[3],h:+m[4],mi:+m[5],dateStr:m[1]+'-'+m[2]+'-'+m[3]}}
function fmtTime(s){const t=parseServerTime(s);return String(t.h).padStart(2,'0')+':'+String(t.mi).padStart(2,'0')}
function fmtDateStr(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function getWeekDays(off){const n=new Date();const m=new Date(n);m.setDate(n.getDate()-((n.getDay()+6)%7)+off*7);const d=[];for(let i=0;i<5;i++){const x=new Date(m);x.setDate(m.getDate()+i);d.push(x)}return d}
function getAssignedWorkout(id){try{return JSON.parse(localStorage.getItem('cf_assign_'+id))}catch{return null}}
let _maxPerSlot=parseInt(localStorage.getItem('cf_maxslot'))||4;

const NAV=[{id:'dashboard',icon:'ğŸ ',lbl:'HOME'},{id:'clients',icon:'ğŸ‘¥',lbl:'CLIENTS'},{id:'scheduler',icon:'ğŸ“…',lbl:'SCHEDULE'},{id:'availability',icon:'ğŸ•',lbl:'SLOTS'},{id:'workouts',icon:'ğŸ’ª',lbl:'WORKOUTS'},{id:'progress',icon:'ğŸ“Š',lbl:'PROGRESS'},{id:'leads',icon:'ğŸ¯',lbl:'LEADS'},{id:'payments',icon:'ğŸ’³',lbl:'PAY'}];
function renderRail(){$('rail').innerHTML='<div class="logo">CF</div>'+NAV.map(n=>'<button onclick="go(\''+n.id+'\')" '+(SCREEN===n.id?'class="active"':'')+'>'+n.icon+'<span>'+n.lbl+'</span></button>').join('')+'<button onclick="doLogout()" style="margin-top:auto">ğŸšª<span>EXIT</span></button>'}
function go(s){SCREEN=s;renderRail();render()}
function doLogout(){localStorage.removeItem('cf_user');USER=null;renderApp()}

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogin(){$('rail').innerHTML='';$('app').innerHTML=`<div style="max-width:380px;margin:80px auto;text-align:center"><div class="logo" style="width:48px;height:48px;font-size:18px;margin:0 auto 12px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:var(--accent);color:#000;font-weight:800">CF</div><h1 style="font-size:20px;margin-bottom:4px">CoachFlow</h1><p style="color:var(--text-2);font-size:12px;margin-bottom:24px">Sign in</p><div id="le" style="display:none;background:rgba(248,113,113,.15);color:var(--red);padding:8px;border-radius:8px;font-size:11px;margin-bottom:10px"></div><div class="form-group"><label>Email</label><input id="lE" type="email" placeholder="ravi@fitforge.in"></div><div class="form-group"><label>Password</label><input id="lP" type="password" placeholder="coach123"></div><button class="btn btn-accent" style="width:100%;padding:10px;font-size:13px;margin-top:4px" onclick="doLogin()">Sign In</button></div>`}
async function doLogin(){const e=$('lE').value,p=$('lP').value;if(!e||!p)return;const d=await api('/auth/login',{method:'POST',body:JSON.stringify({email:e,password:p})});if(d.success){USER=d.user;localStorage.setItem('cf_user',JSON.stringify(d.user));renderApp()}else{$('le').style.display='block';$('le').textContent=d.detail||'Login failed'}}

// â”€â”€â”€ DASHBOARD (clickable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderDashboard(){
  $('app').innerHTML=`<div class="topbar"><h2>Dashboard<span class="sub">${h(USER?.full_name)}</span></h2></div><div class="loading">Loading...</div>`;
  const[stats,today]=await Promise.all([api('/dashboard/stats'),api('/schedule/today')]);
  const s=stats.stats||{};const ss=(today.sessions||[]).filter(x=>x.status!=='cancelled');
  $('app').innerHTML=`
  <div class="topbar"><h2>Dashboard<span class="sub">${h(USER?.full_name)} Â· ${new Date().toLocaleDateString('en-IN',{weekday:'short',month:'short',day:'numeric'})}</span></h2></div>
  <div class="grid-4">
    <div class="card stat" onclick="go('scheduler')"><h3 style="color:var(--accent)">${ss.length}</h3><p>Today's Sessions</p></div>
    <div class="card stat" onclick="go('clients')"><h3 style="color:var(--green)">${s.total_clients||0}</h3><p>Active Clients</p></div>
    <div class="card stat" onclick="go('workouts')"><h3 style="color:var(--blue)">${s.total_workouts||0}</h3><p>Workouts</p></div>
    <div class="card stat" onclick="go('leads')"><h3 style="color:var(--yellow)">${s.total_leads||0}</h3><p>Leads</p></div>
  </div>
  <div class="card"><div class="card-title">Today's Sessions</div>
  ${ss.length?ss.map(se=>{
    const attended=se.status==='confirmed'||se.status==='completed';
    const absent=se.status==='no_show';
    const canMark=!attended&&!absent;
    return`<div class="clickable" style="display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-bottom:1px solid var(--bg-3)">
    <div style="flex:1"><strong style="font-size:12px">${h(se.client_name)}</strong>
    <div style="font-size:10px;color:var(--text-2)">${fmtTime(se.scheduled_at)} Â· ${se.duration_minutes}min${se.workout_name?' Â· '+h(se.workout_name):''}</div></div>
    <div style="display:flex;gap:4px;align-items:center">
      ${attended?'<span style="color:var(--green);font-weight:800;font-size:14px">âœ“</span>':''}
      ${absent?'<span style="color:var(--red);font-weight:800;font-size:14px">âœ—</span>':''}
      <span class="badge ${attended?'badge-green':absent?'badge-red':'badge-yellow'}">${se.status}</span>
      ${canMark?`<button class="btn btn-sm btn-green" onclick="dashAtt('${se.id}','present')">âœ“</button><button class="btn btn-sm btn-red" onclick="dashAtt('${se.id}','absent')">âœ—</button>`:''}
    </div></div>`}).join(''):'<div class="empty">No sessions today</div>'}</div>`;
}
async function dashAtt(sid,st){await api('/sessions/'+sid+'/mark-attendance',{method:'POST',body:JSON.stringify({status:st})});toast(st==='present'?'âœ“ Present':'âœ— Absent');renderDashboard()}

// â”€â”€â”€ CLIENTS (enhanced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _allClients=[];
async function renderClients(){
  $('app').innerHTML=`<div class="topbar"><h2>Clients</h2><div style="display:flex;gap:6px"><button class="btn" onclick="showBulkImport()">ğŸ“¤ Bulk Import</button><button class="btn btn-accent" onclick="showAddClient()">+ Add Client</button></div></div><div class="loading">Loading...</div>`;
  const d=await api('/clients');_allClients=d.clients||[];
  $('app').innerHTML=`<div class="topbar"><h2>Clients (${_allClients.length})</h2><div style="display:flex;gap:6px"><button class="btn" onclick="showBulkImport()">ğŸ“¤ Bulk Import</button><button class="btn btn-accent" onclick="showAddClient()">+ Add Client</button></div></div>
  <div class="card">${_allClients.length?`<table><tr><th>Name</th><th>Email</th><th>Phone</th><th>Goal</th><th>Weight</th><th>Workouts</th><th>Type</th><th></th></tr>
  ${_allClients.map(c=>{const m=typeof c.metadata==='string'?JSON.parse(c.metadata):c.metadata||{};const wk=getAssignedWorkout(c.id);const ph=localStorage.getItem('cf_photo_'+c.id);
  return`<tr><td><div style="display:flex;align-items:center;gap:6px">${ph?'<img src="'+ph+'" style="width:28px;height:28px;border-radius:6px;object-fit:cover">':'<div style="width:28px;height:28px;border-radius:6px;background:var(--bg-3);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--accent)">'+(c.name||'?')[0]+'</div>'}<div><strong>${h(c.name)}</strong>${wk?'<div style="font-size:9px;color:var(--accent)">'+h(wk.name)+'</div>':''}</div></div></td>
  <td style="color:var(--text-2);font-size:11px">${h(c.email||'â€”')}</td><td style="color:var(--text-2);font-size:11px">${h(c.phone||'â€”')}</td>
  <td><span class="badge badge-accent">${h(m.goal||'â€”')}</span></td>
  <td style="font-size:11px">${m.weight?m.weight+'kg':'â€”'}</td>
  <td style="color:var(--text-2);font-size:11px">${(()=>{const mp=JSON.parse(localStorage.getItem('cf_wkmap_'+c.id)||'[]');return mp.length?mp.length+' workout'+(mp.length>1?'s':''):'â€”'})()}</td>
  <td><span class="badge ${(m.type||'').toLowerCase()==='online'?'badge-blue':'badge-green'}">${h(m.type||'Offline')}</span></td>
  <td style="display:flex;gap:4px"><span class="cli-eye" onclick="openClientPanel('${c.id}')" style="opacity:.6;font-size:14px;cursor:pointer" title="View">ğŸ‘</span><span class="cli-eye" onclick="openProgressView('${c.id}')" style="opacity:.6;font-size:14px;cursor:pointer" title="Progress">ğŸ“Š</span><button class="btn btn-sm btn-red" onclick="delClient('${c.id}')">âœ•</button></td></tr>`}).join('')}</table>`
  :'<div class="empty">No clients yet</div>'}</div>`;
}
function showAddClient(){document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal" style="max-width:540px"><h3>Add Client</h3>
<div style="font-size:10px;color:var(--text-3);margin-bottom:10px">Fields marked * are required</div>
<div class="form-row"><div><label>Full Name *</label><input id="cn" placeholder="Rahul Sharma"></div><div><label>Phone</label><input id="cp" placeholder="+91..."></div></div>
<div class="form-row"><div><label>Email</label><input id="ce" type="email"></div><div><label>Type</label><select id="ct"><option>Offline</option><option>Online</option></select></div></div>
<div class="form-row"><div><label>Goal</label><input id="cg" placeholder="Muscle Gain / Weight Loss"></div><div><label>Start Date</label><input id="cstart" type="date" value="${fmtDateStr(new Date())}"></div></div>
<div style="border-top:1px solid var(--border);margin:10px 0;padding-top:10px">
<div style="font-size:11px;font-weight:600;margin-bottom:6px">Health Details</div>
<div class="form-row"><div><label>Current Weight (kg)</label><input id="cwt" type="number" placeholder="75"></div><div><label>Height (cm)</label><input id="cht" type="number" placeholder="170"></div></div>
<div class="form-group"><label>Injuries / Medical Conditions</label><input id="cinj" placeholder="Knee pain, Lower back issue..."></div>
<div class="form-group"><label>Diet Restrictions</label><input id="cdiet" placeholder="Vegetarian, No dairy, Gluten-free..."></div>
<div class="form-group"><label>Additional Notes</label><textarea id="cnotes" rows="2" placeholder="Training history, preferences..."></textarea></div>
</div>
<div style="border-top:1px solid var(--border);margin:10px 0;padding-top:10px">
<div class="form-row"><div><label>Monthly Fee (â‚¹)</label><input id="cfee" type="number" placeholder="5000"></div><div><label>Photo</label><input id="cphoto" type="file" accept="image/*" onchange="previewClientPhoto(this)"></div></div>
<div id="cphotoPreview" style="display:none;margin-top:4px"><img id="cphotoPrev" style="width:48px;height:48px;border-radius:8px;object-fit:cover;border:1px solid var(--border)"></div>
</div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn btn-accent" onclick="addClient()">Add Client</button></div></div></div>`)}

function previewClientPhoto(inp){const f=inp.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{$('cphotoPrev').src=e.target.result;$('cphotoPreview').style.display=''};r.readAsDataURL(f)}

async function addClient(){
  const n=$('cn').value;if(!n)return toast('Name required',false);
  const fee=$('cfee').value;const start=$('cstart').value;
  // Read photo as base64
  let photoB64=null;const photoInp=$('cphoto');
  if(photoInp&&photoInp.files[0]){photoB64=await new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(photoInp.files[0])})}
  const d=await api('/clients',{method:'POST',body:JSON.stringify({name:n,email:$('ce').value,phone:$('cp').value,goal:$('cg').value,type:$('ct').value})});
  if(!d.success)return toast(d.detail||'Error',false);
  closeModal();
  const cid=d.client.id;
  // Store extended metadata locally + attempt API
  const meta={goal:$('cg').value,type:$('ct').value,weight:$('cwt').value,height:$('cht').value,injuries:$('cinj').value,diet:$('cdiet').value,notes:$('cnotes')?.value||'',start_date:start};
  api('/clients/'+cid+'/metadata',{method:'PUT',body:JSON.stringify(meta)});
  localStorage.setItem('cf_meta_'+cid,JSON.stringify(meta));
  if(fee)localStorage.setItem('cf_fee_'+cid,JSON.stringify({fee,start_date:start,plan:'monthly'}));
  if(photoB64)localStorage.setItem('cf_photo_'+cid,photoB64);
  // If weight provided, create initial progress record
  if($('cwt').value){api('/progress/upload',{method:'POST',body:JSON.stringify({client_id:cid,weight:parseFloat($('cwt').value),measurements:{height:parseFloat($('cht').value)||null},date:start||fmtDateStr(new Date()),notes:'Initial measurement'})})}
  toast('Client added');renderClients();
}
async function delClient(id){if(!confirm('Delete?'))return;await api('/clients/'+id,{method:'DELETE'});localStorage.removeItem('cf_photo_'+id);localStorage.removeItem('cf_meta_'+id);localStorage.removeItem('cf_fee_'+id);toast('Deleted');renderClients()}

// â”€â”€ BULK IMPORT (XLSX) â”€â”€
function showBulkImport(){document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal" style="max-width:500px"><h3>ğŸ“¤ Bulk Import Clients</h3>
<p style="font-size:11px;color:var(--text-2);margin-bottom:10px">Upload an Excel file (.xlsx) with columns: Name, Email, Phone, Goal, Type, Weight, Injuries, Diet, Monthly Fee</p>
<div class="form-group"><label>Excel File (.xlsx)</label><input id="bulkFile" type="file" accept=".xlsx,.xls,.csv"></div>
<div id="bulkPreview" style="display:none;margin:10px 0;max-height:200px;overflow-y:auto;font-size:10px;background:var(--bg-2);border-radius:8px;padding:8px"></div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button>
<button class="btn" onclick="downloadTemplate()">ğŸ“¥ Template</button>
<button class="btn btn-accent" id="bulkBtn" onclick="doBulkImport()" disabled>Import</button></div></div></div>`);
$('bulkFile').addEventListener('change',parseBulkFile)}

function downloadTemplate(){
  // Generate CSV template as fallback (XLSX template is separate file)
  const csv='Name,Email,Phone,Goal,Type,Weight (kg),Injuries,Diet Restrictions,Monthly Fee\\nRahul Sharma,rahul@email.com,+919876543210,Muscle Gain,Offline,78,None,Vegetarian,5000';
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='client_import_template.csv';a.click();toast('Template downloaded')
}

let _bulkClients=[];
async function parseBulkFile(){
  const file=$('bulkFile').files[0];if(!file)return;
  _bulkClients=[];
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'){
    const text=await file.text();const lines=text.trim().split('\\n');
    const hdr=lines[0].split(',').map(h=>h.trim().toLowerCase());
    for(let i=1;i<lines.length;i++){
      const vals=lines[i].split(',');const obj={};hdr.forEach((h,j)=>obj[h]=vals[j]?.trim()||'');
      _bulkClients.push({name:obj.name||obj['full name']||'',email:obj.email||'',phone:obj.phone||'',goal:obj.goal||'',type:obj.type||'Offline',weight:obj['weight (kg)']||obj.weight||'',injuries:obj.injuries||'',diet:obj['diet restrictions']||obj.diet||'',fee:obj['monthly fee']||obj.fee||''});
    }
  } else {
    // XLSX - use SheetJS from CDN
    if(!window.XLSX){const s=document.createElement('script');s.src='https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';document.head.appendChild(s);await new Promise(r=>{s.onload=r;s.onerror=()=>{toast('Failed to load XLSX parser',false);r()}})}
    if(window.XLSX){const data=await file.arrayBuffer();const wb=XLSX.read(data);const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws);
    _bulkClients=rows.map(r=>({name:r.Name||r.name||r['Full Name']||'',email:r.Email||r.email||'',phone:String(r.Phone||r.phone||''),goal:r.Goal||r.goal||'',type:r.Type||r.type||'Offline',weight:r['Weight (kg)']||r.Weight||r.weight||'',injuries:r.Injuries||r.injuries||'',diet:r['Diet Restrictions']||r.Diet||r.diet||'',fee:r['Monthly Fee']||r.Fee||r.fee||''}));}
  }
  _bulkClients=_bulkClients.filter(c=>c.name);
  $('bulkPreview').style.display='';
  $('bulkPreview').innerHTML=`<strong>${_bulkClients.length} clients found:</strong><br>`+_bulkClients.map((c,i)=>`${i+1}. ${h(c.name)} â€” ${h(c.email||'no email')} â€” ${h(c.goal||'â€”')}`).join('<br>');
  $('bulkBtn').disabled=_bulkClients.length===0;
}
async function doBulkImport(){
  if(!_bulkClients.length)return;
  $('bulkBtn').textContent='Importing...';$('bulkBtn').disabled=true;
  // Use the bulk-import endpoint
  const apiClients=_bulkClients.map(c=>({name:c.name,email:c.email||null,phone:c.phone||null}));
  const d=await api('/clients/bulk-import',{method:'POST',body:JSON.stringify({clients:apiClients})});
  // Store metadata locally for each imported client
  // We can't get IDs back from bulk import, so we'll save metadata by name
  _bulkClients.forEach(c=>{localStorage.setItem('cf_bulkmeta_'+c.name.toLowerCase(),JSON.stringify({goal:c.goal,type:c.type,weight:c.weight,injuries:c.injuries,diet:c.diet,fee:c.fee}))});
  closeModal();
  if(d.success){toast(d.message||'Imported');renderClients()}else toast(d.detail||'Error',false);
}


// â”€â”€â”€ SCHEDULER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _clients=[],_weekOffset=0;
async function renderScheduler(){
  $('app').innerHTML=`<div class="topbar"><h2>Scheduler</h2><div style="display:flex;gap:6px"><button class="btn" onclick="showReplicateDay()">ğŸ“‹ Replicate</button><button class="btn" onclick="showSlotConfig()">âš™ ${_maxPerSlot}/slot</button><button class="btn btn-accent" onclick="showAddSession()">+ Session</button></div></div><div class="loading">Loading...</div>`;
  const[sd,cd,hd]=await Promise.all([api('/sessions'),api('/clients'),api('/holidays')]);
  const sessions=sd.sessions||[];_clients=cd.clients||[];
  const holidays=(hd.holidays||[]).map(x=>x.holiday_date);
  const days=getWeekDays(_weekOffset);const dayLabels=['Mon','Tue','Wed','Thu','Fri'];
  const dayStrs=days.map(fmtDateStr);const now=new Date();const todayStr=fmtDateStr(now);const nowHr=now.getHours();
  const isTodayWeek=dayStrs.includes(todayStr);
  const hours=[5,6,7,8,9,10,11,12,13,14,15,16,17,18,19];
  function sessAt(ds,hr){return sessions.filter(s=>{const t=parseServerTime(s.scheduled_at);return t.dateStr===ds&&t.h===hr})}
  function evHtml(s){
    const nm=(s.client_name||'').split(' ')[0];const wk=s.workout_name?'Â·'+s.workout_name.split(' ')[0]:'';const on=s.location==='online';
    const cancelled=s.status==='cancelled';const attended=s.status==='confirmed'||s.status==='completed';const absent=s.status==='no_show';
    const stIcon=attended?'<span style="color:var(--green);font-weight:800">âœ“</span>':absent?'<span style="color:var(--red);font-weight:800">âœ—</span>':'';
    const canMark=!cancelled&&!attended&&!absent;
    return`<div class="sched-evt ${on?'online':'offline'}" style="${cancelled?'opacity:.3;text-decoration:line-through':attended?'opacity:.8':''}"><span class="evt-main">${on?'ğŸŒ':'ğŸ‹ï¸'} ${h(nm)}${wk?' '+wk:''} ${stIcon}</span><span class="evt-actions">${canMark?'<span class="evt-att att-ok" onclick="event.stopPropagation();schedAtt(\''+s.id+'\',\'present\')">âœ“</span><span class="evt-att att-no" onclick="event.stopPropagation();schedAtt(\''+s.id+'\',\'absent\')">âœ—</span>':''}<span class="evt-del" onclick="event.stopPropagation();delSess(\''+s.id+'\')">âœ•</span></span></div>`}
  let g='<div></div>'+days.map((d,i)=>{const ds=dayStrs[i];const isToday=ds===todayStr;const isHol=holidays.includes(ds);const df=d.getDate()+'/'+(d.getMonth()+1);return`<div class="sched-hdr ${isToday?'is-today':''} ${isHol?'is-holiday':''}">${dayLabels[i]} <span style="font-size:9px;font-weight:400">${df}</span>${isHol?'<div style="font-size:8px;color:var(--red)">Holiday</div>':''}<span class="cancel-day-btn" onclick="cancelDay('${ds}')">âŠ˜ cancel</span></div>`}).join('');
  for(const hr of hours){
    const isNowHr=isTodayWeek&&hr===nowHr;
    g+=`<div class="sched-time ${isNowHr?'now-hr':''}">${String(hr).padStart(2,'0')}:00</div>`;
    for(let di=0;di<5;di++){const evts=sessAt(dayStrs[di],hr);const active=evts.filter(e=>e.status!=='cancelled');const over=active.length>_maxPerSlot;const atMax=active.length===_maxPerSlot;const isNowCell=dayStrs[di]===todayStr&&hr===nowHr;
    g+=`<div class="sched-cell ${over?'full':atMax?'at-max':''} ${isNowCell?'now-slot':''}" data-day="${dayStrs[di]}" data-hr="${hr}" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event)">${evts.map(evHtml).join('')}<span class="slot-cap ${over?'full':atMax?'at-max':''}">${active.length}/${_maxPerSlot}</span></div>`}}
  const cliHtml=_clients.map(c=>{const m=typeof c.metadata==='string'?JSON.parse(c.metadata):c.metadata||{};const on=(m.type||'').toLowerCase()==='online';const wkN=(getAssignedWorkout(c.id)||{}).name||'';return`<div class="cli ${on?'online':'offline'}" draggable="true" ondragstart="onDragStart(event,'${c.id}','${h(c.name)}')">${on?'ğŸŒ':'ğŸ‹ï¸'} <span style="flex:1;min-width:0"><span style="display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${h(c.name?.split(' ')[0])}</span>${wkN?'<span style="font-size:9px;color:var(--accent)">'+h(wkN)+'</span>':''}</span><span class="cli-eye" onclick="event.stopPropagation();openClientPanel('${c.id}')">ğŸ‘</span></div>`}).join('');
  const wkLabel=days[0].toLocaleDateString('en-IN',{day:'numeric',month:'short'})+' â€“ '+days[4].toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
  $('app').innerHTML=`<div class="topbar"><h2>Scheduler</h2><div style="display:flex;gap:6px"><button class="btn" onclick="showReplicateDay()">ğŸ“‹ Replicate</button><button class="btn" onclick="showSlotConfig()">âš™ ${_maxPerSlot}/slot</button><button class="btn btn-accent" onclick="showAddSession()">+ Session</button></div></div>
  <div class="card"><div class="card-title">Coach Calendar</div><div class="date-nav"><button onclick="_weekOffset--;renderScheduler()">â—€</button><button class="today-btn" onclick="_weekOffset=0;renderScheduler()">Today</button><button onclick="_weekOffset++;renderScheduler()">â–¶</button><span style="font-size:12px;font-weight:600">${wkLabel}</span><input type="date" value="${todayStr}" onchange="jumpToDate(this.value)" style="margin-left:auto;width:140px"></div>
  <div class="sched-wrap"><div class="sched-sidebar"><div style="font-size:10px;color:var(--text-3);margin-bottom:6px">Drag clients â†’</div>${cliHtml||'<div class="empty" style="padding:10px">No clients</div>'}</div><div class="sched-grid" style="grid-template-columns:50px repeat(5,1fr)">${g}</div></div></div>`}

function jumpToDate(v){const t=new Date(v);const n=new Date();const nm=new Date(n);nm.setDate(n.getDate()-((n.getDay()+6)%7));const tm=new Date(t);tm.setDate(t.getDate()-((t.getDay()+6)%7));_weekOffset=Math.round((tm-nm)/(7*864e5));renderScheduler()}
function showSlotConfig(){document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>âš™ Max Slots Per Hour</h3><div class="form-group"><label>Maximum sessions per time slot</label><input id="msi" type="number" min="1" max="20" value="${_maxPerSlot}"></div><div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="_maxPerSlot=parseInt($('msi').value)||4;localStorage.setItem('cf_maxslot',_maxPerSlot);closeModal();toast('Max: '+_maxPerSlot);renderScheduler()">Save</button></div></div></div>`)}
async function cancelDay(ds){if(!confirm('Cancel ALL sessions on '+ds+'?'))return;const sd=await api('/sessions');const ss=(sd.sessions||[]).filter(s=>parseServerTime(s.scheduled_at).dateStr===ds&&s.status!=='cancelled');if(!ss.length)return toast('No active sessions',false);for(const s of ss)await api('/sessions/'+s.id+'/cancel',{method:'POST',body:JSON.stringify({reason:'Day cancelled'})});toast('Cancelled '+ss.length);renderScheduler()}
function onDragStart(ev,id,nm){ev.dataTransfer.setData('clientId',id)}
function onDragOver(ev){ev.preventDefault();ev.currentTarget.classList.add('drag-over')}
function onDragLeave(ev){ev.currentTarget.classList.remove('drag-over')}
async function onDrop(ev){ev.preventDefault();ev.currentTarget.classList.remove('drag-over');const id=ev.dataTransfer.getData('clientId');const day=ev.currentTarget.dataset.day;const hr=ev.currentTarget.dataset.hr;if(!id||!day||!hr)return;const a=getAssignedWorkout(id);const b={client_id:id,scheduled_at:day+'T'+String(hr).padStart(2,'0')+':00',duration_minutes:60,location:'offline'};if(a?.id)b.workout_id=a.id;const d=await api('/sessions',{method:'POST',body:JSON.stringify(b)});if(d.success){toast('Scheduled'+(a?.name?' Â· '+a.name:''));renderScheduler()}else toast(d.detail||'Error',false)}
async function showAddSession(){const[cd,wd]=await Promise.all([api('/clients'),api('/workouts/library')]);document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>Schedule Session</h3><div class="form-group"><label>Client</label><select id="sc">${(cd.clients||[]).map(c=>'<option value="'+c.id+'">'+h(c.name)+'</option>').join('')}</select></div><div class="form-row"><div><label>Date</label><input id="sd" type="date" value="${fmtDateStr(new Date())}"></div><div><label>Time</label><input id="st" type="time" value="09:00"></div></div><div class="form-row"><div><label>Duration</label><input id="su" type="number" value="60"></div><div><label>Workout</label><select id="sw"><option value="">None</option>${(wd.workouts||[]).map(w=>'<option value="'+w.id+'">'+h(w.name)+'</option>').join('')}</select></div></div><div class="form-group"><label>Location</label><select id="sl"><option>offline</option><option>online</option></select></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="addSess()">Schedule</button></div></div></div>`)}
async function addSess(){const b={client_id:$('sc').value,scheduled_at:$('sd').value+'T'+$('st').value,duration_minutes:parseInt($('su').value)||60,location:$('sl').value};if($('sw').value)b.workout_id=$('sw').value;const d=await api('/sessions',{method:'POST',body:JSON.stringify(b)});closeModal();if(d.success){toast('Scheduled');renderScheduler()}else toast(d.detail||'Error',false)}
async function delSess(id){if(!confirm('Remove?'))return;await api('/sessions/'+id,{method:'DELETE'});toast('Removed');renderScheduler()}
async function schedAtt(sid,st){await api('/sessions/'+sid+'/mark-attendance',{method:'POST',body:JSON.stringify({status:st})});toast(st==='present'?'âœ“ Present':'âœ— Absent');renderScheduler()}

// â”€â”€â”€ AVAILABILITY + HOLIDAYS â”€â”€â”€â”€â”€â”€â”€â”€
async function renderAvailability(){
  $('app').innerHTML=`<div class="topbar"><h2>Availability & Holidays</h2></div><div class="loading">Loading...</div>`;
  const[ad,hd]=await Promise.all([api('/availability'),api('/holidays')]);
  const av=ad.availability||{};const wd=av.working_days||[1,2,3,4,5];const slots=av.slots||[];const holidays=hd.holidays||[];
  const dn=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  $('app').innerHTML=`<div class="topbar"><h2>Availability & Holidays</h2></div>
  <div class="grid-2"><div>
    <div class="card"><div class="card-title">Working Days</div><div id="wdc">${dn.map((d,i)=>'<span class="chip '+(wd.includes(i+1)?'active':'')+'" onclick="this.classList.toggle(\'active\')" data-d="'+(i+1)+'">'+d+'</span>').join('')}</div><button class="btn btn-accent" style="margin-top:8px" onclick="saveDays()">Save Days</button></div>
    <div class="card"><div class="card-title"><span>Time Slots (${slots.length})</span><button class="btn btn-accent btn-sm" onclick="showAddSlot()">+ Add</button></div>${slots.length?slots.map((s,i)=>'<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bg-3)"><div><strong style="font-size:12px">'+h(s.label||'Slot')+'</strong> <span style="color:var(--text-2);font-size:11px">'+h(s.start)+' â€“ '+h(s.end)+'</span></div><button class="btn btn-sm btn-red" onclick="delSlot('+i+')">âœ•</button></div>').join(''):'<div class="empty">No slots</div>'}</div>
  </div><div>
    <div class="card"><div class="card-title"><span>Holidays (${holidays.length})</span><button class="btn btn-accent btn-sm" onclick="showAddHoliday()">+ Add Holiday</button></div>${holidays.length?holidays.map(x=>'<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bg-3)"><div><strong style="font-size:12px">'+x.holiday_date+'</strong> <span style="color:var(--text-2);font-size:11px">'+h(x.reason||'')+'</span></div><button class="btn btn-sm btn-red" onclick="delHoliday(\''+x.id+'\')">âœ•</button></div>').join(''):'<div class="empty">No holidays</div>'}</div>
  </div></div>`}
async function saveDays(){const chips=document.querySelectorAll('#wdc .chip');const wd=[];chips.forEach(c=>{if(c.classList.contains('active'))wd.push(parseInt(c.dataset.d))});const ad=await api('/availability');await api('/availability',{method:'PUT',body:JSON.stringify({working_days:wd,slots:(ad.availability||{}).slots||[]})});toast('Saved')}
function showAddSlot(){document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>Add Time Slot</h3><div class="form-group"><label>Label</label><input id="sll" placeholder="Morning Batch"></div><div class="form-row"><div><label>Start</label><input id="sls" type="time" value="09:00"></div><div><label>End</label><input id="sle" type="time" value="12:00"></div></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="addSlot()">Add</button></div></div></div>`)}
async function addSlot(){const ad=await api('/availability');const av=ad.availability||{};const slots=av.slots||[];slots.push({label:$('sll').value||'Slot',start:$('sls').value,end:$('sle').value});const r=await api('/availability',{method:'PUT',body:JSON.stringify({working_days:av.working_days||[1,2,3,4,5],slots})});closeModal();if(r.success){toast('Added');renderAvailability()}else toast(r.detail||'Error',false)}
async function delSlot(i){const ad=await api('/availability');const av=ad.availability||{};const slots=av.slots||[];slots.splice(i,1);await api('/availability',{method:'PUT',body:JSON.stringify({working_days:av.working_days||[1,2,3,4,5],slots})});toast('Deleted');renderAvailability()}
function showAddHoliday(){document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>Add Holiday</h3><div class="form-group"><label>Date</label><input id="hdd" type="date"></div><div class="form-group"><label>Reason</label><input id="hdr" placeholder="Diwali, Leave..."></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="addHoliday()">Add</button></div></div></div>`)}
async function addHoliday(){const v=$('hdd').value;if(!v)return toast('Pick a date',false);const d=await api('/holidays',{method:'POST',body:JSON.stringify({date:v,reason:$('hdr').value||''})});closeModal();if(d.success){toast('Holiday added');renderAvailability()}else toast(d.detail||'Error: '+JSON.stringify(d),false)}
async function delHoliday(id){await api('/holidays/'+id,{method:'DELETE'});toast('Deleted');renderAvailability()}

// â”€â”€â”€ WORKOUTS (hierarchical) â”€â”€â”€â”€â”€â”€â”€â”€
const WK_CATEGORIES={
  'Strength Training':['Chest','Back','Shoulders','Biceps','Triceps','Legs','Core','Full Body'],
  'Cardio':['Running','Cycling','Swimming','HIIT','Jump Rope','Rowing'],
  'Flexibility':['Yoga','Stretching','Pilates','Mobility'],
  'Functional':['CrossFit','Kettlebell','Bodyweight','Resistance Bands'],
  'Sports Specific':['Boxing','Martial Arts','Cricket','Football']
};
let _allWorkouts=[];
async function renderWorkouts(){
  $('app').innerHTML=`<div class="topbar"><h2>Workouts</h2><button class="btn btn-accent" onclick="showAddWk()">+ Add Workout</button></div><div class="loading">Loading...</div>`;
  const d=await api('/workouts/library');_allWorkouts=d.workouts||[];
  // Group by category
  const grouped={};_allWorkouts.forEach(w=>{const cat=w.category||'Other';if(!grouped[cat])grouped[cat]=[];grouped[cat].push(w)});
  const catHtml=Object.entries(grouped).map(([cat,wks])=>`
    <div class="card" style="margin-bottom:8px">
      <div class="card-title" style="cursor:pointer" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">
        <span>ğŸ’ª ${h(cat)} <span class="badge badge-accent">${wks.length}</span></span>
        <span style="font-size:10px;color:var(--text-3)">â–¼</span>
      </div>
      <div>${wks.map(w=>{
        const sub=w.description?.includes('[')?w.description.split('[')[1].split(']')[0]:'';
        return`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--bg-3)">
          <div><strong style="font-size:12px">${h(w.name)}</strong>${sub?'<span class="badge badge-blue" style="margin-left:4px;font-size:9px">'+h(sub)+'</span>':''}
          <div style="font-size:10px;color:var(--text-2)">${h((w.description||'').replace(/\[.*\]/,'').trim())} Â· ${w.duration_minutes}min</div></div>
          <button class="btn btn-sm btn-red" onclick="delWk('${w.id}')">âœ•</button></div>`}).join('')}
      </div>
    </div>`).join('');
  $('app').innerHTML=`<div class="topbar"><h2>Workouts Library (${_allWorkouts.length})</h2><button class="btn btn-accent" onclick="showAddWk()">+ Add</button></div>${catHtml||'<div class="empty">No workouts. Click + Add.</div>'}`;
}
function showAddWk(){
  const catOpts=Object.keys(WK_CATEGORIES).map(c=>'<option value="'+c+'">'+c+'</option>').join('');
  document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>Add Workout</h3>
  <div class="form-group"><label>Name</label><input id="wn" placeholder="Bench Press 5x5"></div>
  <div class="form-row"><div><label>Category</label><select id="wc" onchange="updateSubCat()">${catOpts}</select></div>
  <div><label>Sub-category</label><select id="wsc"><option>General</option></select></div></div>
  <div class="form-group"><label>Description</label><textarea id="wde" rows="2" placeholder="3 sets of 12 reps, rest 60s..."></textarea></div>
  <div class="form-group"><label>Duration (min)</label><input id="wdu" type="number" value="45"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button>
  <button class="btn btn-accent" onclick="addWk()">Add</button></div></div></div>`);
  updateSubCat();
}
function updateSubCat(){const cat=$('wc').value;const subs=WK_CATEGORIES[cat]||[];$('wsc').innerHTML=subs.map(s=>'<option>'+s+'</option>').join('')+'<option>General</option>'}
async function addWk(){const sub=$('wsc').value;const desc=($('wde').value||'')+(sub&&sub!=='General'?' ['+sub+']':'');const d=await api('/workouts/library',{method:'POST',body:JSON.stringify({name:$('wn').value,description:desc,category:$('wc').value,duration_minutes:parseInt($('wdu').value)||45})});closeModal();if(d.success){toast('Added');renderWorkouts()}else toast(d.detail||'Error',false)}
async function delWk(id){if(!confirm('Delete?'))return;await api('/workouts/'+id,{method:'DELETE'});toast('Deleted');renderWorkouts()}

// â”€â”€â”€ LEADS (with delete) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderLeads(){$('app').innerHTML=`<div class="topbar"><h2>Leads</h2></div><div class="loading">Loading...</div>`;const d=await api('/leads');const leads=(d.leads||[]).filter(l=>l.status!=='archived');const nw=leads.filter(l=>l.status==='new'),cont=leads.filter(l=>l.status==='contacted'),conv=leads.filter(l=>l.status==='converted');
function lc(l){return'<div class="card" style="padding:8px;margin-bottom:5px"><div style="display:flex;justify-content:space-between"><strong style="font-size:11px">'+h(l.name)+'</strong><div style="display:flex;gap:3px">'+(l.status!=='converted'?'<button class="btn btn-sm" onclick="updateLead(\''+l.id+'\',\'contacted\')">ğŸ“</button><button class="btn btn-sm btn-green" onclick="convertLead(\''+l.id+'\')">âœ“</button>':'')+'<button class="btn btn-sm btn-red" onclick="archiveLead(\''+l.id+'\')" title="Delete">âœ•</button></div></div><div style="font-size:10px;color:var(--text-2)">'+h(l.phone||'')+(l.email?' Â· '+h(l.email):'')+'</div>'+(l.message?'<div style="font-size:10px;color:var(--text-3);margin-top:2px">'+h(l.message).substring(0,80)+'</div>':'')+'</div>'}
$('app').innerHTML=`<div class="topbar"><h2>Leads Pipeline</h2></div><div class="grid-3"><div><div class="card-title"><span class="badge badge-yellow">ğŸ†• New (${nw.length})</span></div>${nw.map(lc).join('')||'<div class="empty" style="padding:16px">â€”</div>'}</div><div><div class="card-title"><span class="badge badge-blue">ğŸ“ Contacted (${cont.length})</span></div>${cont.map(lc).join('')||'<div class="empty" style="padding:16px">â€”</div>'}</div><div><div class="card-title"><span class="badge badge-green">âœ… Converted (${conv.length})</span></div>${conv.map(lc).join('')||'<div class="empty" style="padding:16px">â€”</div>'}</div></div>`}
async function updateLead(id,st){await api('/leads/'+id,{method:'PATCH',body:JSON.stringify({status:st})});toast('Updated');renderLeads()}
async function convertLead(id){if(!confirm('Convert?'))return;const d=await api('/leads/'+id+'/convert',{method:'POST'});if(d.success)toast(d.message||'Converted!');else toast(d.detail||'Error',false);renderLeads()}
async function archiveLead(id){if(!confirm('Delete this lead?'))return;await api('/leads/'+id,{method:'PATCH',body:JSON.stringify({status:'archived'})});toast('Deleted');renderLeads()}

// â”€â”€â”€ PAYMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderPayments(){
  $('app').innerHTML=`<div class="topbar"><h2>Payments</h2><button class="btn btn-accent" onclick="showRazorpay()">ğŸ’³ Send Payment Link</button></div><div class="loading">Loading...</div>`;
  const cd=await api('/clients');const clients=cd.clients||[];
  // Load payment info from localStorage
  const rows=clients.map(c=>{const p=JSON.parse(localStorage.getItem('cf_fee_'+c.id)||'null');return{...c,payment:p}}).filter(c=>c.payment);
  $('app').innerHTML=`<div class="topbar"><h2>Payments</h2><button class="btn btn-accent" onclick="showRazorpay()">ğŸ’³ Send Payment Link</button></div>
  <div class="card"><div class="card-title">Client Payment Plans</div>
  ${rows.length?'<table><tr><th>Client</th><th>Plan</th><th>Fee</th><th>Start</th><th>Razorpay</th></tr>'+rows.map(c=>'<tr><td>'+h(c.name)+'</td><td><span class="badge badge-accent">'+(c.payment.plan||'monthly')+'</span></td><td style="font-weight:700">â‚¹'+h(c.payment.fee)+'</td><td style="color:var(--text-2)">'+h(c.payment.start_date||'â€”')+'</td><td><button class="btn btn-sm btn-accent" onclick="sendRzp(\''+c.id+'\','+c.payment.fee+')">Send Link</button></td></tr>').join('')+'</table>':'<div class="empty">No payment plans. Add fee while creating clients or send Razorpay links below.</div>'}
  </div>`;
}
function showRazorpay(){api('/clients').then(cd=>{const cl=cd.clients||[];document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>ğŸ’³ Send Razorpay Link</h3><div class="form-group"><label>Client</label><select id="rzCli">${cl.map(c=>'<option value="'+c.id+'">'+h(c.name)+'</option>').join('')}</select></div><div class="form-group"><label>Amount (â‚¹)</label><input id="rzAmt" type="number" placeholder="5000"></div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="sendRzpModal()">Send Link</button></div></div></div>`)})}
async function sendRzpModal(){const d=await api('/payments/create-razorpay-link',{method:'POST',body:JSON.stringify({client_id:$('rzCli').value,amount:parseFloat($('rzAmt').value)||0})});closeModal();if(d.success){toast('Link: '+d.payment_link);prompt('Payment link (copy):',d.payment_link)}else toast(d.detail||'Error',false)}
async function sendRzp(cid,amt){const d=await api('/payments/create-razorpay-link',{method:'POST',body:JSON.stringify({client_id:cid,amount:amt})});if(d.success){toast('Link created');prompt('Send this to client:',d.payment_link)}else toast(d.detail||'Error',false)}

// â”€â”€â”€ CLIENT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openClientPanel(clientId){
  const client=(_allClients.length?_allClients:_clients).find(c=>c.id===clientId);
  if(!client)return;const m=typeof client.metadata==='string'?JSON.parse(client.metadata):client.metadata||{};
  const lm=JSON.parse(localStorage.getItem('cf_meta_'+clientId)||'null')||m;
  const photo=localStorage.getItem('cf_photo_'+clientId);
  document.body.insertAdjacentHTML('beforeend',`<div class="cli-panel-bg" id="cliPanelBg" onclick="if(event.target===this)closeClientPanel()"><div class="cli-panel" id="cliPanel"><h3>${h(client.name)}<button class="btn btn-sm" onclick="closeClientPanel()">âœ•</button></h3><div class="loading">Loading...</div></div></div>`);
  const[sd,wd]=await Promise.all([api('/sessions?client_id='+clientId),api('/workouts/library')]);
  const sessions=sd.sessions||[];const workouts=wd.workouts||[];
  const now=new Date();const localAssign=getAssignedWorkout(clientId);const assignId=localAssign?.id||'';const assignName=localAssign?.name||'None';
  const upcoming=sessions.filter(s=>{const t=parseServerTime(s.scheduled_at);return new Date(t.y,t.mo-1,t.d,t.h,t.mi)>=now&&s.status!=='cancelled'});
  const past=sessions.filter(s=>{const t=parseServerTime(s.scheduled_at);return new Date(t.y,t.mo-1,t.d,t.h,t.mi)<now||s.status==='completed'||s.status==='no_show'});
  const fee=JSON.parse(localStorage.getItem('cf_fee_'+clientId)||'null');
  function si(s){const st=parseServerTime(s.scheduled_at);const attended=s.status==='confirmed'||s.status==='completed';const absent=s.status==='no_show';const badge=attended?'badge-green':absent?'badge-red':'badge-yellow';return`<div class="sess-item"><div style="display:flex;flex-direction:column;gap:2px"><span>${fmtTime(s.scheduled_at)} Â· ${s.duration_minutes}min</span><span style="color:var(--text-2);font-size:10px">${st.dateStr}</span>${s.workout_name?'<span style="color:var(--accent);font-size:10px;font-weight:600">'+h(s.workout_name)+'</span>':''}</div><span class="badge ${badge}">${attended?'âœ“ Present':absent?'âœ— Absent':s.status}</span></div>`}
  $('cliPanel').innerHTML=`<h3>${h(client.name)}<button class="btn btn-sm" onclick="closeClientPanel()">âœ•</button></h3>
  <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px">${photo?'<img src="'+photo+'" style="width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid var(--border)">':''}
  <div><div style="font-size:11px;color:var(--text-2)">${h(client.email||'')}${client.phone?' Â· '+h(client.phone):''}</div>
  <div style="font-size:11px;margin-top:2px">${lm.goal?'<span class="badge badge-accent">'+h(lm.goal)+'</span> ':''}<span class="badge badge-blue">${lm.type||'Offline'}</span>${fee?' <span class="badge badge-green">â‚¹'+h(fee.fee)+'/mo</span>':''}</div></div></div>

  ${lm.weight||lm.injuries||lm.diet?`<div style="padding:8px;background:var(--bg-2);border-radius:8px;margin-bottom:10px;font-size:11px">
  ${lm.weight?'<div>âš– <strong>Weight:</strong> '+lm.weight+'kg'+(lm.height?' Â· <strong>Height:</strong> '+lm.height+'cm':'')+'</div>':''}
  ${lm.injuries?'<div style="color:var(--red)">âš  <strong>Injuries:</strong> '+h(lm.injuries)+'</div>':''}
  ${lm.diet?'<div style="color:var(--yellow)">ğŸ½ <strong>Diet:</strong> '+h(lm.diet)+'</div>':''}
  ${lm.notes?'<div style="color:var(--text-2)">ğŸ“ '+h(lm.notes)+'</div>':''}
  </div>`:''}

  <div style="display:flex;gap:6px;margin-bottom:10px"><button class="btn btn-accent btn-sm" onclick="closeClientPanel();openProgressView('${clientId}')">ğŸ“Š Progress</button><button class="btn btn-sm" onclick="closeClientPanel();showRecordProgress('${clientId}')">+ Record</button><button class="btn btn-sm" onclick="shareProgress('${clientId}','whatsapp')">ğŸ“± WhatsApp</button><button class="btn btn-sm" onclick="shareProgress('${clientId}','email')">ğŸ“§ Email</button></div>

  <div class="card" style="padding:10px;margin-bottom:10px"><div class="card-title" style="font-size:12px">Mapped Workouts</div>
  <div id="mappedWkList" style="margin-bottom:6px">${(()=>{const mapped=JSON.parse(localStorage.getItem('cf_wkmap_'+clientId)||'[]');return mapped.length?mapped.map(w=>'<span class="chip active" style="font-size:10px">'+h(w.name)+' <span onclick="unmapWk(\''+clientId+'\',\''+w.id+'\')" style="cursor:pointer;color:var(--red)">âœ•</span></span>').join(''):'<span style="font-size:10px;color:var(--text-3)">No workouts mapped</span>'})()}</div>
  <div style="display:flex;gap:6px;align-items:center"><select id="assignWk" style="flex:1;padding:6px;font-size:11px"><option value="">â€” Select Workout â€”</option>${workouts.map(w=>'<option value="'+w.id+'">'+h(w.name)+' ('+h(w.category)+')</option>').join('')}</select><button class="btn btn-accent btn-sm" onclick="mapWk('${clientId}')">+ Map</button></div></div>
  <div class="tab-row"><button class="tab-btn active" onclick="switchTab(this,'upcoming')">Upcoming (${upcoming.length})</button><button class="tab-btn" onclick="switchTab(this,'past')">Past (${past.length})</button></div>
  <div id="panelUpcoming">${upcoming.length?upcoming.slice(0,20).map(si).join(''):'<div class="empty" style="padding:12px">No upcoming</div>'}</div>
  <div id="panelPast" style="display:none">${past.length?past.slice(0,30).map(si).join(''):'<div class="empty" style="padding:12px">No past sessions</div>'}</div>
  <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--border)"><div class="grid-3" style="gap:6px"><div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--green)">${past.filter(s=>s.status==='confirmed'||s.status==='completed').length}</div><div style="font-size:9px;color:var(--text-3)">Attended</div></div><div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--red)">${past.filter(s=>s.status==='no_show').length}</div><div style="font-size:9px;color:var(--text-3)">Absent</div></div><div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--accent)">${upcoming.length}</div><div style="font-size:9px;color:var(--text-3)">Upcoming</div></div></div></div>`}
function closeClientPanel(){document.getElementById('cliPanelBg')?.remove()}
function switchTab(btn,tab){btn.parentElement.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');$('panelUpcoming').style.display=tab==='upcoming'?'':'none';$('panelPast').style.display=tab==='past'?'':'none'}
function mapWk(cid){const sel=$('assignWk');const id=sel.value;if(!id)return toast('Select a workout',false);const nm=sel.selectedOptions[0].textContent.split(' (')[0].trim();const mapped=JSON.parse(localStorage.getItem('cf_wkmap_'+cid)||'[]');if(mapped.find(w=>w.id===id))return toast('Already mapped',false);mapped.push({id,name:nm});localStorage.setItem('cf_wkmap_'+cid,JSON.stringify(mapped));localStorage.setItem('cf_assign_'+cid,JSON.stringify({id,name:nm}));toast('Mapped: '+nm);closeClientPanel();openClientPanel(cid)}
function unmapWk(cid,wid){let mapped=JSON.parse(localStorage.getItem('cf_wkmap_'+cid)||'[]');mapped=mapped.filter(w=>w.id!==wid);localStorage.setItem('cf_wkmap_'+cid,JSON.stringify(mapped));if(mapped.length)localStorage.setItem('cf_assign_'+cid,JSON.stringify(mapped[0]));else localStorage.removeItem('cf_assign_'+cid);toast('Removed');closeClientPanel();openClientPanel(cid)}

async function shareProgress(clientId,method){
  const client=(_allClients.length?_allClients:_clients).find(c=>c.id===clientId);if(!client)return;
  const pd=await api('/progress/'+clientId);const records=pd.records||[];
  const sd=await api('/sessions?client_id='+clientId);const sessions=sd.sessions||[];
  const attended=sessions.filter(s=>s.status==='confirmed'||s.status==='completed').length;
  const total=sessions.filter(s=>s.status!=='cancelled').length;
  const latest=records[0];const met=latest?(typeof latest.metrics==='string'?JSON.parse(latest.metrics):latest.metrics):{};
  const mapped=JSON.parse(localStorage.getItem('cf_wkmap_'+clientId)||'[]');

  let msg=`ğŸ“Š *${client.name} â€” Progress Report*\n`;
  msg+=`ğŸ“… Date: ${new Date().toLocaleDateString('en-IN')}\n\n`;
  if(met.weight)msg+=`âš– Current Weight: ${met.weight}kg\n`;
  if(latest?.recorded_at)msg+=`ğŸ“ Last Measured: ${latest.recorded_at.split(' ')[0]||latest.recorded_at.split('T')[0]}\n`;
  const ms=met.measurements||{};
  if(Object.keys(ms).length){msg+=`\nğŸ“ *Measurements:*\n`;Object.entries(ms).filter(([k,v])=>v).forEach(([k,v])=>{msg+=`  ${k}: ${v}cm\n`})}
  msg+=`\nğŸ‹ï¸ *Attendance:* ${attended}/${total} sessions (${total?Math.round(attended/total*100):0}%)\n`;
  if(mapped.length){msg+=`\nğŸ’ª *Workouts:* ${mapped.map(w=>w.name).join(', ')}\n`}
  msg+=`\nâ€” CoachFlow`;

  if(method==='whatsapp'){
    const phone=(client.phone||'').replace(/[^0-9]/g,'');
    const url=phone?'https://wa.me/'+phone+'?text='+encodeURIComponent(msg):'https://wa.me/?text='+encodeURIComponent(msg);
    window.open(url,'_blank');toast('Opening WhatsApp...');
  } else {
    const subject='Progress Report â€” '+client.name;
    const url='mailto:'+(client.email||'')+'?subject='+encodeURIComponent(subject)+'&body='+encodeURIComponent(msg.replace(/\*/g,''));
    window.open(url);toast('Opening Email...');
  }
}

// â”€â”€â”€ REPLICATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _repSessions=[];
async function showReplicateDay(){const days=getWeekDays(_weekOffset);const dn=['Monday','Tuesday','Wednesday','Thursday','Friday'];const dayStrs=days.map(fmtDateStr);const sd=await api('/sessions');_repSessions=sd.sessions||[];const counts=dayStrs.map(ds=>_repSessions.filter(s=>parseServerTime(s.scheduled_at).dateStr===ds&&s.status!=='cancelled').length);const def4w=new Date();def4w.setDate(def4w.getDate()+28);
document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal"><h3>ğŸ“‹ Replicate Schedule</h3><p style="font-size:11px;color:var(--text-2);margin-bottom:10px">Copy a day's sessions to other days, optionally repeating weekly.</p>
<div class="form-group"><label>Source day</label><select id="repFrom">${dn.map((d,i)=>'<option value="'+i+'">'+d+' ('+counts[i]+' sessions)</option>').join('')}</select></div>
<div class="form-group"><label>Mode</label><div style="display:flex;gap:8px;margin-top:4px"><label style="font-size:11px;cursor:pointer"><input type="radio" name="repMode" value="week" checked onchange="$('repUW').style.display='none'"> This week</label><label style="font-size:11px;cursor:pointer"><input type="radio" name="repMode" value="until" onchange="$('repUW').style.display=''"> Weekly until date</label></div></div>
<div id="repUW" class="form-group" style="display:none"><label>Until</label><input id="repUntil" type="date" value="${fmtDateStr(def4w)}"></div>
<div class="form-group"><label>Target days</label><div id="repTo">${dn.map((d,i)=>'<span class="chip" onclick="this.classList.toggle(\'active\')" data-dow="'+i+'">'+d+'</span>').join('')}</div></div>
<div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button><button class="btn btn-accent" onclick="doReplicate()">Replicate</button></div></div></div>`)}
async function doReplicate(){
  const fromIdx=parseInt($('repFrom').value);const days=getWeekDays(_weekOffset);const dayStrs=days.map(fmtDateStr);const fromDay=dayStrs[fromIdx];
  const mode=document.querySelector('input[name=repMode]:checked').value;
  const tDows=[];document.querySelectorAll('#repTo .chip.active').forEach(c=>tDows.push(parseInt(c.dataset.dow)));
  if(!tDows.length)return toast('Select target days',false);
  const src=_repSessions.filter(s=>parseServerTime(s.scheduled_at).dateStr===fromDay&&s.status!=='cancelled');
  if(!src.length)return toast('No sessions on source',false);
  const bulk=[];
  if(mode==='week'){tDows.forEach(dow=>{if(dow===fromIdx)return;src.forEach(s=>{const t=parseServerTime(s.scheduled_at);bulk.push({client_id:s.client_id,scheduled_at:dayStrs[dow]+'T'+String(t.h).padStart(2,'0')+':'+String(t.mi).padStart(2,'0'),duration_minutes:s.duration_minutes,workout_id:s.session_template_id||null})})})}
  else{const until=new Date($('repUntil').value+'T23:59');if(!until)return toast('Set date',false);
    // For each target dow + source dow, generate weekly
    const allDows=[...new Set([...tDows,fromIdx])];
    allDows.forEach(dow=>{let d=new Date(dayStrs[dow]);if(dow===fromIdx)d.setDate(d.getDate()+7);while(d<=until){const ds=fmtDateStr(d);src.forEach(s=>{const t=parseServerTime(s.scheduled_at);bulk.push({client_id:s.client_id,scheduled_at:ds+'T'+String(t.h).padStart(2,'0')+':'+String(t.mi).padStart(2,'0'),duration_minutes:s.duration_minutes,workout_id:s.session_template_id||null})});d.setDate(d.getDate()+7)}})}
  if(!bulk.length)return toast('Nothing to create',false);
  if(bulk.length>50&&!confirm(bulk.length+' sessions will be created. Continue?'))return;
  const d=await api('/schedule/bulk-plan',{method:'POST',body:JSON.stringify({sessions:bulk})});closeModal();
  if(d.success)toast(d.message||bulk.length+' sessions created');else toast(d.detail||'Error',false);renderScheduler()}

// â”€â”€â”€ PROGRESS TRACKING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _progressClient=null;
async function renderProgress(){
  $('app').innerHTML=`<div class="topbar"><h2>Progress Tracker</h2></div><div class="loading">Loading clients...</div>`;
  const cd=await api('/clients');const clients=cd.clients||[];
  $('app').innerHTML=`<div class="topbar"><h2>ğŸ“Š Progress Tracker</h2></div>
  <div class="card"><div class="card-title">Select Client</div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">${clients.map(c=>`<button class="btn" onclick="openProgressView('${c.id}')" style="display:flex;align-items:center;gap:4px">${(()=>{const ph=localStorage.getItem('cf_photo_'+c.id);return ph?'<img src="'+ph+'" style="width:20px;height:20px;border-radius:4px;object-fit:cover">':'<span style="width:20px;height:20px;border-radius:4px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:9px;color:#000;font-weight:700">'+(c.name||'?')[0]+'</span>'})()}${h(c.name?.split(' ')[0])}</button>`).join('')}</div></div>
  ${_progressClient?'':'<div class="empty" style="padding:40px">Select a client to view or record progress</div>'}`;
}

async function openProgressView(clientId){
  _progressClient=clientId;
  const client=(_allClients.length?_allClients:(_clients||[])).find(c=>c.id===clientId);
  const name=client?.name||'Client';
  const m=client?.metadata?(typeof client.metadata==='string'?JSON.parse(client.metadata):client.metadata):{};
  const lm=JSON.parse(localStorage.getItem('cf_meta_'+clientId)||'null')||m;
  const photo=localStorage.getItem('cf_photo_'+clientId);
  const fee=JSON.parse(localStorage.getItem('cf_fee_'+clientId)||'null');
  const startDate=lm.start_date||fee?.start_date||client?.created_at?.split('T')[0]||'';

  $('app').innerHTML=`<div class="topbar"><h2>ğŸ“Š ${h(name)}</h2><div style="display:flex;gap:6px"><button class="btn" onclick="renderProgress()">â† Back</button><button class="btn btn-accent" onclick="showRecordProgress('${clientId}')">+ Record Progress</button></div></div><div class="loading">Loading...</div>`;

  const pd=await api('/progress/'+clientId);
  const records=pd.records||[];

  // Extract weight timeline
  const weightData=records.filter(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics;return met?.weight}).map(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics;return{date:r.recorded_at?.split(' ')[0]||r.recorded_at?.split('T')[0]||'',weight:parseFloat(met.weight),meas:met.measurements||{}}}).reverse();

  // Photos timeline
  const photos=[];for(let i=0;i<50;i++){const ph=localStorage.getItem('cf_progress_photo_'+clientId+'_'+i);if(ph){const dt=localStorage.getItem('cf_progress_photo_date_'+clientId+'_'+i);photos.push({src:ph,date:dt||''})}}

  // Calculate journey stats
  const firstW=weightData.length?weightData[0].weight:null;
  const lastW=weightData.length?weightData[weightData.length-1].weight:null;
  const diff=firstW&&lastW?(lastW-firstW).toFixed(1):null;

  $('app').innerHTML=`<div class="topbar"><h2>ğŸ“Š ${h(name)}'s Journey</h2><div style="display:flex;gap:6px"><button class="btn" onclick="renderProgress()">â† Back</button><button class="btn btn-accent" onclick="showRecordProgress('${clientId}')">+ Record</button></div></div>

  <div class="grid-2">
  <div>
    <div class="card">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        ${photo?'<img src="'+photo+'" style="width:56px;height:56px;border-radius:12px;object-fit:cover;border:2px solid var(--border)">':'<div style="width:56px;height:56px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:24px;color:#000;font-weight:800">'+(name[0])+'</div>'}
        <div>
          <div style="font-size:16px;font-weight:700">${h(name)}</div>
          <div style="font-size:11px;color:var(--text-2)">${h(lm.goal||'')} Â· Since ${startDate||'â€”'}</div>
          ${lm.injuries?'<div style="font-size:10px;color:var(--red)">âš  '+h(lm.injuries)+'</div>':''}
          ${lm.diet?'<div style="font-size:10px;color:var(--yellow)">ğŸ½ '+h(lm.diet)+'</div>':''}
        </div>
      </div>
      <div class="grid-4" style="gap:6px">
        <div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--accent)">${lastW||'â€”'}</div><div style="font-size:9px;color:var(--text-3)">Current kg</div></div>
        <div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:${diff&&diff<0?'var(--green)':'var(--red)'}">${diff?diff>0?'+'+diff:diff:'â€”'}</div><div style="font-size:9px;color:var(--text-3)">Change kg</div></div>
        <div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--blue)">${records.length}</div><div style="font-size:9px;color:var(--text-3)">Records</div></div>
        <div style="text-align:center;padding:8px;background:var(--bg-2);border-radius:8px"><div style="font-size:18px;font-weight:800;color:var(--green)">${lm.height||'â€”'}</div><div style="font-size:9px;color:var(--text-3)">Height cm</div></div>
      </div>
    </div>

    ${weightData.length>1?`<div class="card"><div class="card-title">Weight Trend</div>
    <div style="height:120px;display:flex;align-items:flex-end;gap:3px;padding:4px">
      ${(()=>{const mn=Math.min(...weightData.map(d=>d.weight));const mx=Math.max(...weightData.map(d=>d.weight));const range=mx-mn||1;return weightData.map(d=>{const pct=((d.weight-mn)/range)*100;return`<div title="${d.date}: ${d.weight}kg" style="flex:1;background:var(--accent);border-radius:3px 3px 0 0;min-height:4px;height:${Math.max(10,pct)}%;cursor:help;position:relative"><span style="position:absolute;top:-14px;left:50%;transform:translateX(-50%);font-size:8px;color:var(--text-3);white-space:nowrap">${d.weight}</span></div>`}).join('')})()}
    </div>
    <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--text-3);margin-top:2px"><span>${weightData[0]?.date}</span><span>${weightData[weightData.length-1]?.date}</span></div>
    </div>`:''}
  </div>
  <div>
    <div class="card"><div class="card-title"><span>Measurements Log (${records.length})</span></div>
    ${records.length?records.map(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics||{};const ms=met.measurements||{};
    return`<div style="padding:8px;border-bottom:1px solid var(--bg-3);font-size:11px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><strong>${r.recorded_at?.split(' ')[0]||r.recorded_at?.split('T')[0]||'â€”'}</strong>${met.weight?'<span class="badge badge-accent">'+met.weight+'kg</span>':''}</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px">${Object.entries(ms).filter(([k,v])=>v).map(([k,v])=>'<span class="badge badge-blue" style="font-size:9px">'+h(k)+': '+v+'</span>').join('')}</div>
    ${r.notes?'<div style="font-size:10px;color:var(--text-3);margin-top:2px">'+h(r.notes)+'</div>':''}</div>`}).join(''):'<div class="empty" style="padding:16px">No records yet. Click "+ Record" to start tracking.</div>'}
    </div>

    ${photos.length?`<div class="card"><div class="card-title">Progress Photos</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap">${photos.map(p=>'<div style="position:relative"><img src="'+p.src+'" style="width:72px;height:72px;object-fit:cover;border-radius:8px;border:1px solid var(--border)"><div style="position:absolute;bottom:2px;left:2px;background:rgba(0,0,0,.7);color:#fff;font-size:8px;padding:1px 4px;border-radius:4px">'+p.date+'</div></div>').join('')}</div></div>`:''}
  </div></div>`;
}

function showRecordProgress(clientId){
  document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal" style="max-width:500px"><h3>ğŸ“Š Record Progress</h3>
  <div class="form-row"><div><label>Date</label><input id="prDate" type="date" value="${fmtDateStr(new Date())}"></div><div><label>Weight (kg)</label><input id="prWt" type="number" step="0.1" placeholder="74.5"></div></div>
  <div style="font-size:11px;font-weight:600;margin:8px 0 4px;color:var(--text-1)">Body Measurements (cm)</div>
  <div class="grid-3" style="gap:6px">
    <div><label>Chest</label><input id="prChest" type="number" step="0.5" placeholder="cm"></div>
    <div><label>Waist</label><input id="prWaist" type="number" step="0.5"></div>
    <div><label>Hips</label><input id="prHips" type="number" step="0.5"></div>
    <div><label>Bicep (L)</label><input id="prBicepL" type="number" step="0.5"></div>
    <div><label>Bicep (R)</label><input id="prBicepR" type="number" step="0.5"></div>
    <div><label>Thigh</label><input id="prThigh" type="number" step="0.5"></div>
    <div><label>Calf</label><input id="prCalf" type="number" step="0.5"></div>
    <div><label>Forearm</label><input id="prForearm" type="number" step="0.5"></div>
    <div><label>Body Fat %</label><input id="prBF" type="number" step="0.1"></div>
  </div>
  <div class="form-group" style="margin-top:8px"><label>Notes</label><textarea id="prNotes" rows="2" placeholder="Observations, changes..."></textarea></div>
  <div class="form-group"><label>Progress Photo</label><input id="prPhoto" type="file" accept="image/*"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeModal()">Cancel</button>
  <button class="btn btn-accent" onclick="saveProgress('${clientId}')">Save Record</button></div></div></div>`);
}

async function saveProgress(clientId){
  const measurements={};
  ['Chest','Waist','Hips','BicepL','BicepR','Thigh','Calf','Forearm','BF'].forEach(k=>{
    const v=$('pr'+k)?.value;if(v)measurements[k.replace('BicepL','Bicep L').replace('BicepR','Bicep R').replace('BF','Body Fat %')]=parseFloat(v)});
  const wt=$('prWt').value?parseFloat($('prWt').value):null;
  const d=await api('/progress/upload',{method:'POST',body:JSON.stringify({
    client_id:clientId,weight:wt,measurements,
    date:$('prDate').value,notes:$('prNotes').value||''
  })});
  // Save photo locally
  const photoInp=$('prPhoto');
  if(photoInp&&photoInp.files[0]){
    const b64=await new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(photoInp.files[0])});
    // Find next available photo slot
    let slot=0;while(localStorage.getItem('cf_progress_photo_'+clientId+'_'+slot)&&slot<50)slot++;
    localStorage.setItem('cf_progress_photo_'+clientId+'_'+slot,b64);
    localStorage.setItem('cf_progress_photo_date_'+clientId+'_'+slot,$('prDate').value);
  }
  closeModal();
  if(d.success){toast('Progress recorded');openProgressView(clientId)}else toast(d.detail||'Error',false);
}

// â”€â”€â”€ ROUTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){({dashboard:renderDashboard,clients:renderClients,scheduler:renderScheduler,availability:renderAvailability,workouts:renderWorkouts,progress:renderProgress,leads:renderLeads,payments:renderPayments}[SCREEN]||renderDashboard)()}
function renderApp(){if(!USER)renderLogin();else{renderRail();render()}}
renderApp();
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&!USER&&$('lP'))doLogin()});
</script>
</body>
</html>
