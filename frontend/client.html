<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>CoachFlow â€” My Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg-0:#0c0f14;--bg-1:#12161e;--bg-2:#191f2b;--bg-3:#212938;--border:#2a3347;--accent:#e8a838;--green:#34d399;--red:#f87171;--yellow:#fbbf24;--blue:#60a5fa;--text-0:#f4f0eb;--text-1:#c8c2b8;--text-2:#8a8477;--text-3:#5e5a52;--font:'Outfit',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg-0);color:var(--text-0);min-height:100vh;max-width:480px;margin:0 auto;padding:0 0 80px}
.header{background:var(--bg-1);border-bottom:1px solid var(--border);padding:14px 16px;position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:16px;font-weight:700}.header .sub{font-size:11px;color:var(--text-2)}
.section{padding:12px 16px}
.card{background:var(--bg-1);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:10px}
.card-title{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600}
.badge-green{background:rgba(52,211,153,.15);color:var(--green)}.badge-red{background:rgba(248,113,113,.15);color:var(--red)}
.badge-yellow{background:rgba(251,191,36,.15);color:var(--yellow)}.badge-blue{background:rgba(96,165,250,.15);color:var(--blue)}
.badge-accent{background:rgba(232,168,56,.15);color:var(--accent)}
.stat-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
.stat-box{text-align:center;background:var(--bg-2);border-radius:10px;padding:10px 6px}
.stat-box h3{font-size:22px;font-weight:800;margin-bottom:2px}.stat-box p{font-size:9px;color:var(--text-3)}
.sess{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--bg-2);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;font-size:12px}
.sess .time{font-weight:700;color:var(--accent);min-width:50px}.sess .detail{flex:1;margin:0 8px}
.sess .detail small{display:block;color:var(--text-2);font-size:10px}
.btn{padding:6px 14px;border-radius:7px;border:1px solid var(--border);background:var(--bg-3);color:var(--text-0);font-size:11px;cursor:pointer;font-family:var(--font)}
.btn-accent{background:var(--accent);border-color:var(--accent);color:#000;font-weight:700}
.btn-red{border-color:var(--red);color:var(--red)}.btn-sm{padding:4px 8px;font-size:10px}
.tab-bar{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;background:var(--bg-1);border-top:1px solid var(--border);display:flex;z-index:10}
.tab-bar button{flex:1;padding:10px 0;border:none;background:transparent;color:var(--text-3);font-size:9px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;font-family:var(--font)}
.tab-bar button.active{color:var(--accent)}
.tab-bar button span{font-size:18px}
input,select,textarea{background:var(--bg-2);border:1px solid var(--border);color:var(--text-0);border-radius:7px;padding:8px 10px;font-size:12px;font-family:var(--font);width:100%}
.form-group{margin-bottom:8px}.form-group label{font-size:10px;color:var(--text-2);margin-bottom:3px;display:block}
.login-wrap{padding:40px 24px;text-align:center}
.progress-bar{height:6px;background:var(--bg-3);border-radius:3px;overflow:hidden;margin-top:6px}
.progress-bar .fill{height:100%;border-radius:3px;transition:.3s}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:flex-end;justify-content:center;z-index:100}
.modal{background:var(--bg-1);border:1px solid var(--border);border-radius:16px 16px 0 0;padding:20px;width:100%;max-width:480px;max-height:70vh;overflow-y:auto}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:10px;font-size:11px;z-index:200;animation:fadeIn .3s}
.toast-ok{background:var(--green);color:#000}.toast-err{background:var(--red);color:#fff}
@keyframes fadeIn{from{opacity:0;transform:translateX(-50%) translateY(-10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.empty{text-align:center;padding:24px;color:var(--text-3);font-size:12px}
</style>
</head>
<body>
<div id="app"></div>
<script>
const API_HOSTS=['https://api.coachme.life/api/v1','https://coach-api-1770519048.azurewebsites.net/api/v1'];
const API=location.hostname.includes('coachme.life')?API_HOSTS[0]:API_HOSTS[1];
let CLIENT=null,TAB='home';
try{CLIENT=JSON.parse(localStorage.getItem('cf_client_user'))}catch{}
function toast(m,ok=true){const t=document.createElement('div');t.className='toast '+(ok?'toast-ok':'toast-err');t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
function h(s){return(s||'').replace(/</g,'&lt;')}
function $(id){return document.getElementById(id)}
function closeModal(){document.querySelector('.modal-bg')?.remove()}
async function api(ep,o={}){try{const r=await fetch(API+ep,{headers:{'Content-Type':'application/json'},...o});return await r.json()}catch(e){return{success:false,detail:e.message}}}
function parseServerTime(s){const m=s.match(/(\d{4})-(\d{2})-(\d{2})[T ](\d{2}):(\d{2})/);if(!m)return{h:0,mi:0,dateStr:s};return{y:+m[1],mo:+m[2],d:+m[3],h:+m[4],mi:+m[5],dateStr:m[1]+'-'+m[2]+'-'+m[3]}}
function fmtTime(s){const t=parseServerTime(s);return String(t.h).padStart(2,'0')+':'+String(t.mi).padStart(2,'0')}

// â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLogin(){
  $('app').innerHTML=`<div class="login-wrap">
  <div style="width:56px;height:56px;border-radius:16px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;color:#000;margin:0 auto 12px">CF</div>
  <h1 style="font-size:20px;margin-bottom:4px">My CoachFlow</h1>
  <p style="color:var(--text-2);font-size:12px;margin-bottom:24px">View your training progress</p>
  <div class="form-group"><label>Email</label><input id="clE" type="email" placeholder="your@email.com"></div>
  <div class="form-group"><label>Phone (last 4 digits)</label><input id="clP" placeholder="3210" maxlength="4"></div>
  <button class="btn btn-accent" style="width:100%;padding:10px;margin-top:6px" onclick="clientLogin()">Sign In</button>
  <p style="color:var(--text-3);font-size:10px;margin-top:12px">Your coach has registered you in CoachFlow.<br>Use the email & phone they have on file.</p>
  </div>`;
}
async function clientLogin(){
  const email=$('clE').value;const phone=$('clP').value;
  if(!email)return toast('Enter email',false);
  // Find client by email from public list
  const d=await api('/clients');const clients=d.clients||[];
  const match=clients.find(c=>c.email&&c.email.toLowerCase()===email.toLowerCase()&&(!phone||(c.phone||'').slice(-4)===phone));
  if(!match)return toast('No account found. Check with your coach.',false);
  CLIENT={id:match.id,name:match.name,email:match.email,phone:match.phone,metadata:typeof match.metadata==='string'?JSON.parse(match.metadata):match.metadata||{}};
  localStorage.setItem('cf_client_user',JSON.stringify(CLIENT));
  renderApp();
}

// â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderHome(){
  const sd=await api('/sessions?client_id='+CLIENT.id);
  const sessions=(sd.sessions||[]).filter(s=>s.status!=='cancelled');
  const now=new Date();
  const upcoming=sessions.filter(s=>{const t=parseServerTime(s.scheduled_at);return new Date(t.y,t.mo-1,t.d,t.h,t.mi)>=now});
  const past=sessions.filter(s=>{const t=parseServerTime(s.scheduled_at);return new Date(t.y,t.mo-1,t.d,t.h,t.mi)<now});
  const attended=past.filter(s=>s.status==='confirmed'||s.status==='completed').length;
  const absent=past.filter(s=>s.status==='no_show').length;
  const pct=past.length?Math.round(attended/past.length*100):0;

  $('app').innerHTML=`
  <div class="header"><div><h1>Hey, ${h(CLIENT.name?.split(' ')[0])} ğŸ‘‹</h1><div class="sub">${new Date().toLocaleDateString('en-IN',{weekday:'long',day:'numeric',month:'short'})}</div></div><button class="btn btn-sm" onclick="clientLogout()">Logout</button></div>
  <div class="section">
    <div class="stat-row">
      <div class="stat-box"><h3 style="color:var(--accent)">${upcoming.length}</h3><p>Upcoming</p></div>
      <div class="stat-box"><h3 style="color:var(--green)">${attended}</h3><p>Attended</p></div>
      <div class="stat-box"><h3 style="color:var(--blue)">${pct}%</h3><p>Attendance</p></div>
    </div>
    <div class="card"><div class="card-title">Attendance Rate</div>
    <div class="progress-bar"><div class="fill" style="width:${pct}%;background:${pct>=75?'var(--green)':pct>=50?'var(--yellow)':'var(--red)'}"></div></div>
    <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-3);margin-top:4px"><span>${attended} present</span><span>${absent} absent</span><span>${past.length} total</span></div></div>

    <div class="card"><div class="card-title">Upcoming Sessions</div>
    ${upcoming.length?upcoming.slice(0,5).map(s=>{const t=parseServerTime(s.scheduled_at);return`<div class="sess"><div class="time">${fmtTime(s.scheduled_at)}</div><div class="detail"><strong>${t.dateStr}</strong><small>${s.workout_name||'General'} Â· ${s.duration_minutes}min</small></div><button class="btn btn-sm btn-red" onclick="requestCancel('${s.id}','${t.dateStr} ${fmtTime(s.scheduled_at)}')">Cancel</button></div>`}).join(''):'<div class="empty">No upcoming sessions</div>'}
    </div>
  </div>
  ${renderTabBar()}`;
}

// â”€â”€â”€ SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSchedule(){
  const sd=await api('/sessions?client_id='+CLIENT.id);
  const sessions=(sd.sessions||[]).sort((a,b)=>a.scheduled_at>b.scheduled_at?-1:1);
  $('app').innerHTML=`
  <div class="header"><h1>My Schedule</h1></div>
  <div class="section">
  ${sessions.length?sessions.map(s=>{
    const t=parseServerTime(s.scheduled_at);
    const attended=s.status==='confirmed'||s.status==='completed';const absent=s.status==='no_show';const cancelled=s.status==='cancelled';
    const badge=attended?'badge-green':absent?'badge-red':cancelled?'badge-red':'badge-yellow';
    const icon=attended?'âœ“':absent?'âœ—':cancelled?'âŠ˜':'ğŸ•';
    return`<div class="sess" style="${cancelled?'opacity:.4':''}"><div class="time">${fmtTime(s.scheduled_at)}</div><div class="detail"><strong>${t.dateStr}</strong><small>${s.workout_name||'Session'} Â· ${s.duration_minutes}min</small></div><span class="badge ${badge}">${icon} ${attended?'Present':absent?'Absent':s.status}</span></div>`}).join(''):'<div class="empty">No sessions</div>'}
  </div>${renderTabBar()}`;
}

// â”€â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderProgress(){
  const pd=await api('/progress/'+CLIENT.id);
  const records=pd.records||[];
  const weightData=records.filter(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics;return met?.weight}).map(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics;return{date:r.recorded_at?.split(' ')[0]||'',weight:parseFloat(met.weight),meas:met.measurements||{}}}).reverse();
  const firstW=weightData.length?weightData[0].weight:null;
  const lastW=weightData.length?weightData[weightData.length-1].weight:null;
  const diff=firstW&&lastW?(lastW-firstW).toFixed(1):null;

  $('app').innerHTML=`
  <div class="header"><h1>My Progress</h1></div>
  <div class="section">
    <div class="stat-row">
      <div class="stat-box"><h3 style="color:var(--accent)">${lastW||'â€”'}</h3><p>Current kg</p></div>
      <div class="stat-box"><h3 style="color:${diff&&diff<0?'var(--green)':'var(--red)'}">${diff?diff>0?'+'+diff:diff:'â€”'}</h3><p>Change</p></div>
      <div class="stat-box"><h3 style="color:var(--blue)">${records.length}</h3><p>Records</p></div>
    </div>

    ${weightData.length>1?`<div class="card"><div class="card-title">Weight Journey</div>
    <div style="height:100px;display:flex;align-items:flex-end;gap:3px">
    ${(()=>{const mn=Math.min(...weightData.map(d=>d.weight));const mx=Math.max(...weightData.map(d=>d.weight));const rng=mx-mn||1;return weightData.map(d=>{const pct=((d.weight-mn)/rng)*100;return`<div title="${d.date}: ${d.weight}kg" style="flex:1;background:var(--accent);border-radius:3px 3px 0 0;min-height:4px;height:${Math.max(10,pct)}%;position:relative"><span style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);font-size:7px;color:var(--text-3);white-space:nowrap">${d.weight}</span></div>`}).join('')})()}
    </div></div>`:''}

    <div class="card"><div class="card-title">Measurement History</div>
    ${records.length?records.slice(0,15).map(r=>{const met=typeof r.metrics==='string'?JSON.parse(r.metrics):r.metrics||{};const ms=met.measurements||{};
    return`<div style="padding:8px 0;border-bottom:1px solid var(--bg-3)"><div style="display:flex;justify-content:space-between;margin-bottom:2px"><strong style="font-size:11px">${r.recorded_at?.split(' ')[0]||'â€”'}</strong>${met.weight?'<span class="badge badge-accent">'+met.weight+'kg</span>':''}</div>
    <div style="display:flex;flex-wrap:wrap;gap:3px">${Object.entries(ms).filter(([k,v])=>v).map(([k,v])=>'<span class="badge badge-blue" style="font-size:9px">'+h(k)+': '+v+'</span>').join('')}</div>
    ${r.notes?'<div style="font-size:10px;color:var(--text-3);margin-top:2px">'+h(r.notes)+'</div>':''}</div>`}).join(''):'<div class="empty">No records yet. Your coach will update your progress.</div>'}
    </div>
  </div>${renderTabBar()}`;
}

// â”€â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProfile(){
  const m=CLIENT.metadata||{};
  const fee=JSON.parse(localStorage.getItem('cf_fee_'+CLIENT.id)||'null');
  $('app').innerHTML=`
  <div class="header"><h1>My Profile</h1><button class="btn btn-sm" onclick="clientLogout()">Logout</button></div>
  <div class="section">
    <div class="card" style="text-align:center;padding:20px">
      <div style="width:64px;height:64px;border-radius:16px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:28px;color:#000;font-weight:800;margin:0 auto 8px">${(CLIENT.name||'?')[0]}</div>
      <h2 style="font-size:16px;margin-bottom:4px">${h(CLIENT.name)}</h2>
      <div style="font-size:11px;color:var(--text-2)">${h(CLIENT.email||'')}${CLIENT.phone?' Â· '+h(CLIENT.phone):''}</div>
      <div style="margin-top:8px">${m.goal?'<span class="badge badge-accent">'+h(m.goal)+'</span> ':''}<span class="badge badge-blue">${h(m.type||'Offline')}</span></div>
    </div>
    ${m.weight||m.injuries||m.diet?`<div class="card">
      <div class="card-title">Health Info</div>
      ${m.weight?'<div style="font-size:12px;margin-bottom:4px">âš– Weight: '+m.weight+'kg</div>':''}
      ${m.height?'<div style="font-size:12px;margin-bottom:4px">ğŸ“ Height: '+m.height+'cm</div>':''}
      ${m.injuries?'<div style="font-size:12px;margin-bottom:4px;color:var(--red)">âš  Injuries: '+h(m.injuries)+'</div>':''}
      ${m.diet?'<div style="font-size:12px;margin-bottom:4px;color:var(--yellow)">ğŸ½ Diet: '+h(m.diet)+'</div>':''}
    </div>`:''}
    ${fee?`<div class="card"><div class="card-title">Payment Plan</div><div style="font-size:20px;font-weight:800;color:var(--accent)">â‚¹${h(fee.fee)}<span style="font-size:11px;color:var(--text-2)">/month</span></div></div>`:''}
  </div>${renderTabBar()}`;
}

// â”€â”€â”€ CANCEL REQUEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requestCancel(sid,label){
  document.body.insertAdjacentHTML('beforeend',`<div class="modal-bg" onclick="if(event.target===this)closeModal()"><div class="modal">
  <h3 style="font-size:15px;margin-bottom:10px">Request Cancellation</h3>
  <p style="font-size:12px;color:var(--text-2);margin-bottom:10px">Session: <strong>${label}</strong></p>
  <div class="form-group"><label>Reason</label><textarea id="cancelReason" rows="2" placeholder="Optional reason..."></textarea></div>
  <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" style="flex:1" onclick="closeModal()">Back</button>
  <button class="btn btn-accent" style="flex:1" onclick="doCancel('${sid}')">Request Cancel</button></div></div></div>`);
}
async function doCancel(sid){
  const reason=$('cancelReason')?.value||'Client requested';
  const d=await api('/sessions/'+sid+'/cancel',{method:'POST',body:JSON.stringify({reason})});
  closeModal();
  if(d.success){toast('Cancellation requested');renderHome()}else toast(d.detail||'Error',false);
}

// â”€â”€â”€ TAB BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabBar(){
  return`<div class="tab-bar">
  <button onclick="TAB='home';render()" class="${TAB==='home'?'active':''}"><span>ğŸ </span>Home</button>
  <button onclick="TAB='schedule';render()" class="${TAB==='schedule'?'active':''}"><span>ğŸ“…</span>Schedule</button>
  <button onclick="TAB='progress';render()" class="${TAB==='progress'?'active':''}"><span>ğŸ“Š</span>Progress</button>
  <button onclick="TAB='profile';render()" class="${TAB==='profile'?'active':''}"><span>ğŸ‘¤</span>Profile</button>
  </div>`;
}
function clientLogout(){localStorage.removeItem('cf_client_user');CLIENT=null;renderApp()}
function render(){({home:renderHome,schedule:renderSchedule,progress:renderProgress,profile:renderProfile}[TAB]||renderHome)()}
function renderApp(){if(!CLIENT)renderLogin();else render()}
renderApp();
</script>
</body>
</html>
